<!doctype html><html lang="en_US"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Developing a complete REST API with Loopback - codeaddslife</title><link rel="stylesheet" href="/main.css"><link rel="icon" type="image/png" href="/favicon.png"></head><body><div id="hd"><div class="wr"><a href="/"><img src="/logo.png" alt="codeaddslife"></a></div></div><div class="wr"><h1 id="developing_a_complete_rest_api_with loopback">Developing a complete REST API with Loopback</h1><p><a href="http://loopback.io">Loopback</a> was created as an open source mobile backend-as-a-service framework by <a href="http://strongloop.com">Strongloop</a>. It allows you to setup a REST API in minutes and is based on <a href="http://expressjs.com">Express</a>. </p><p>Here we will use version 3.4.0 to build an API for camping reservations:</p><p><img src="/img/0001_datamodel.png" alt="DataModel"></p><h2 id="getting_started">Getting Started</h2><p>Loopback comes with a <a href="https://loopback.io/doc/en/lb3/Command-line-tools.html">CLI tool</a> to generate an application. You can configure everything manually, but the CLI tool is just a really handy gift to get you started. Install it via the node package manager: <code>npm install -g loopback-cli</code></p><p>When installed, type <code>lb</code> to start the <a href="http://yeoman.io">yeoman-generator</a>:</p><div class="highlight"><pre><span></span>     <span class="nx">_</span><span class="o">-----</span><span class="nx">_</span>
    <span class="o">|</span>       <span class="o">|</span>    <span class="err">╭──────────────────────────╮</span>
    <span class="o">|--</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span><span class="o">--|</span>    <span class="err">│</span>  <span class="nx">Let</span><span class="s1">&#39;s create a LoopBack │</span>
<span class="s1">   `---------´   │       application!       │</span>
<span class="s1">    ( _´U`_ )    ╰──────────────────────────╯</span>
<span class="s1">    /___A___\   /</span>
<span class="s1">     |  ~  |</span>
<span class="s1">   __&#39;</span><span class="p">.</span><span class="nx">___</span><span class="p">.</span><span class="s1">&#39;__</span>
<span class="s1"> ´   `  |° ´ Y `</span>

<span class="s1">? What&#39;</span><span class="nx">s</span> <span class="nx">the</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">your</span> <span class="nx">application</span><span class="o">?</span> <span class="nx">reservations</span>
<span class="o">?</span> <span class="nx">Enter</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">directory</span> <span class="nx">to</span> <span class="nx">contain</span> <span class="nx">the</span> <span class="nx">project</span><span class="o">:</span> <span class="nx">reservations</span>
   <span class="nx">create</span> <span class="nx">reservations</span><span class="o">/</span>
     <span class="nx">info</span> <span class="nx">change</span> <span class="nx">the</span> <span class="nx">working</span> <span class="nx">directory</span> <span class="nx">to</span> <span class="nx">reservations</span>

<span class="o">?</span> <span class="nx">Which</span> <span class="nx">version</span> <span class="k">of</span> <span class="nx">LoopBack</span> <span class="nx">would</span> <span class="nx">you</span> <span class="nx">like</span> <span class="nx">to</span> <span class="nx">use</span><span class="o">?</span> <span class="mf">3.</span><span class="nx">x</span> <span class="p">(</span><span class="nx">current</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">What</span> <span class="nx">kind</span> <span class="k">of</span> <span class="nx">application</span> <span class="k">do</span> <span class="nx">you</span> <span class="nx">have</span> <span class="k">in</span> <span class="nx">mind</span><span class="o">?</span> <span class="nx">empty</span><span class="o">-</span><span class="nx">server</span> <span class="p">(</span><span class="nx">An</span> <span class="nx">empty</span> <span class="nx">LoopBack</span> <span class="nx">API</span><span class="p">,</span> <span class="nx">without</span> <span class="nx">any</span> <span class="nx">configured</span> <span class="nx">models</span> <span class="nx">or</span> <span class="nx">datasources</span><span class="p">)</span>
</pre></div><p>When finished, you will see the following project structure. The JSON files are for configuration and the Javascript files are for extending Express.</p><div class="highlight"><pre><span></span><span class="nx">reservations</span><span class="o">/</span>
<span class="err">├──</span> <span class="nx">client</span>                       <span class="err">#</span> <span class="nx">Client</span> <span class="nx">JS</span><span class="p">,</span> <span class="nx">HTML</span> <span class="nx">and</span> <span class="nx">CSS</span> <span class="nx">files</span>
<span class="err">│</span> <span class="err">└──</span> <span class="nx">README</span><span class="p">.</span><span class="nx">md</span>                  <span class="err">#</span> <span class="nx">Empty</span> <span class="nx">README</span><span class="p">.</span><span class="nx">md</span> <span class="nx">file</span>
<span class="err">├──</span> <span class="kr">package</span><span class="p">.</span><span class="nx">json</span>                 <span class="err">#</span> <span class="nx">Npm</span> <span class="kr">package</span> <span class="nx">specification</span>
<span class="err">└──</span> <span class="nx">server</span>                       <span class="err">#</span> <span class="nx">Node</span> <span class="nx">scripts</span> <span class="nx">and</span> <span class="nx">config</span>
 <span class="err">├──</span> <span class="nx">boot</span>                        <span class="err">#</span> <span class="nx">Initialization</span> <span class="nx">scripts</span>
 <span class="err">│</span> <span class="err">└──</span> <span class="nx">root</span><span class="p">.</span><span class="nx">js</span>                   <span class="err">#</span> <span class="nx">Specify</span> <span class="nx">the</span> <span class="nx">contextroot</span>
 <span class="err">├──</span> <span class="nx">component</span><span class="o">-</span><span class="nx">config</span><span class="p">.</span><span class="nx">json</span>       <span class="err">#</span> <span class="nx">Loopback</span> <span class="nx">components</span> <span class="nx">config</span>
 <span class="err">├──</span> <span class="nx">config</span><span class="p">.</span><span class="nx">json</span>                 <span class="err">#</span> <span class="nx">Global</span> <span class="nx">settings</span>
 <span class="err">├──</span> <span class="nx">datasources</span><span class="p">.</span><span class="nx">json</span>            <span class="err">#</span> <span class="nx">Datasource</span> <span class="nx">config</span>
 <span class="err">├──</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">development</span><span class="p">.</span><span class="nx">json</span> <span class="err">#</span> <span class="nx">Middleware</span> <span class="nx">config</span> <span class="k">for</span> <span class="nx">dev</span>
 <span class="err">├──</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">json</span>             <span class="err">#</span> <span class="nx">Middleware</span> <span class="nx">config</span>
 <span class="err">├──</span> <span class="nx">model</span><span class="o">-</span><span class="nx">config</span><span class="p">.</span><span class="nx">json</span>           <span class="err">#</span> <span class="nx">Binds</span> <span class="nx">models</span> <span class="nx">to</span> <span class="nx">datasources</span>
 <span class="err">└──</span> <span class="nx">server</span><span class="p">.</span><span class="nx">js</span>                   <span class="err">#</span> <span class="nx">Main</span> <span class="nx">application</span> <span class="nx">script</span>
</pre></div><p>Go to the reservations folder and start the application by running npm start. Open http://localhost:3000/explorer in your browser to see a basic <a href="http://swagger.io/swagger-ui/">Swagger-UI</a></p><h2 id="persistence">Persistence</h2><p>Look at server/datasources.json. We have no datasources configured yet. We will use an in-memory database here, but there are many <a href="https://loopback.io/doc/en/lb3/Database-connectors.html">database connectors available</a> out-of-the-box.</p><p>Type <code>lb datasource</code> to start the generator again.</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">data</span><span class="o">-</span><span class="nx">source</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">reservationDS</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">connector</span> <span class="k">for</span> <span class="nx">reservationDS</span><span class="o">:</span> <span class="nx">In</span><span class="o">-</span><span class="nx">memory</span> <span class="nx">db</span> <span class="p">(</span><span class="nx">supported</span> <span class="nx">by</span> <span class="nx">StrongLoop</span><span class="p">)</span>
<span class="nx">Connector</span><span class="o">-</span><span class="nx">specific</span> <span class="nx">configuration</span><span class="o">:</span>
<span class="o">?</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="nx">key</span> <span class="nx">to</span> <span class="nx">use</span> <span class="k">for</span> <span class="nx">persistence</span> <span class="p">(</span><span class="nx">browser</span> <span class="nx">only</span><span class="p">)</span><span class="o">:</span>
<span class="o">?</span> <span class="nx">Full</span> <span class="nx">path</span> <span class="nx">to</span> <span class="nx">file</span> <span class="k">for</span> <span class="nx">persistence</span> <span class="p">(</span><span class="nx">server</span> <span class="nx">only</span><span class="p">)</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">json</span>
</pre></div><p>The db.json file will persist the in-memory data to a file. This allows us to keep our data when we restart the server. It also allows us to start our application with some test data.</p><p>We will create this file later on. Loopback won't give any warning when this file is not available yet.</p><h2 id="models">Models</h2><p>Loopback is designed around the concept of <a href="https://loopback.io/doc/en/lb3/Defining-models.html">models</a>. Let's create a model for our campground, <code>lb model</code></p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">campground</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">data</span><span class="o">-</span><span class="nx">source</span> <span class="nx">to</span> <span class="nx">attach</span> <span class="nx">campground</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">reservationDS</span> <span class="p">(</span><span class="nx">memory</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">model</span><span class="s1">&#39;s base class PersistedModel</span>
<span class="s1">? Expose campground via the REST API? Yes</span>
<span class="s1">? Custom plural form (used to build REST URL):</span>
<span class="s1">? Common model or server only? server</span>
<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">some</span> <span class="nx">campground</span> <span class="nx">properties</span> <span class="nx">now</span><span class="p">.</span>

<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span>
   <span class="nx">invoke</span>   <span class="nx">loopback</span><span class="o">:</span><span class="nx">property</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span>
<span class="o">?</span> <span class="nx">Required</span><span class="o">?</span> <span class="nx">Yes</span>
<span class="o">?</span> <span class="nx">Default</span> <span class="nx">value</span><span class="p">[</span><span class="nx">leave</span> <span class="nx">blank</span> <span class="k">for</span> <span class="nx">none</span><span class="p">]</span><span class="o">:</span>

<span class="nx">Let</span><span class="s1">&#39;s add another campground property.</span>
<span class="s1">Enter an empty property name when done.</span>
<span class="s1">? Property name: location</span>
<span class="s1">   invoke   loopback:property</span>
<span class="s1">? Property type: geopoint</span>
<span class="s1">? Required? No</span>
<span class="s1">? Default value[leave blank for none]:</span>

<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">another</span> <span class="nx">campground</span> <span class="nx">property</span><span class="p">.</span>
<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span>
</pre></div><p>We created the campground model and derived it from the PersistedModel, so we can save it to our datasource. You can make a model common, which means that the same model can be shared between the client and the server, but we decided to use it for the server only.</p><p>Our model has 2 properties, a name and a location. The id property is automatically included, so you don’t have to add it.</p><p>Visit the API explorer at http://localhost:3000/explorer. You'll see a lot of endpoints available for our campgrounds now.</p><p><img src="/img/0001_explorer.png" alt="API Explorer"></p><p>Let's test our API by getting all the campgrounds:</p><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="s1">&#39;http://localhost:3000/api/campgrounds&#39;</span>
</pre></div><p>Since we don't have any data, the response will be an empty list. We now create the db.json file that we specified in the previous section. Create a db.json file at the root of the project.</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;ids&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="mi">5</span>
  <span class="p">},</span>
  <span class="s2">&quot;models&quot;</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="p">{</span>
       <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Salt Lake City KOA\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 40.772112, \&quot;lng\&quot;: -111.932165},\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Gouldings Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 37.006989, \&quot;lng\&quot;: -110.214907},\&quot;id\&quot;:2}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;3&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Grand Canyon Mather Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 36.056472, \&quot;lng\&quot;: -112.140728},\&quot;id\&quot;:3}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;4&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Camping Paris Bois de Boulogne\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 48.868879, \&quot;lng\&quot;: 2.234914},\&quot;id\&quot;:4}&quot;</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Restart the server and try again. You should now see 4 campgrounds. We will finish this part by generating our reservation model, lb model:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">reservation</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">data</span><span class="o">-</span><span class="nx">source</span> <span class="nx">to</span> <span class="nx">attach</span> <span class="nx">reservation</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">reservationDS</span> <span class="p">(</span><span class="nx">memory</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">model</span><span class="s1">&#39;s base class PersistedModel</span>
<span class="s1">? Expose reservation via the REST API? Yes</span>
<span class="s1">? Custom plural form (used to build REST URL):</span>
<span class="s1">? Common model or server only? server</span>
<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">some</span> <span class="nx">reservation</span> <span class="nx">properties</span> <span class="nx">now</span><span class="p">.</span>

<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">startDate</span>
   <span class="nx">invoke</span>   <span class="nx">loopback</span><span class="o">:</span><span class="nx">property</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">date</span>
<span class="o">?</span> <span class="nx">Required</span><span class="o">?</span> <span class="nx">Yes</span>
<span class="o">?</span> <span class="nx">Default</span> <span class="nx">value</span><span class="p">[</span><span class="nx">leave</span> <span class="nx">blank</span> <span class="k">for</span> <span class="nx">none</span><span class="p">]</span><span class="o">:</span>

<span class="nx">Let</span><span class="s1">&#39;s add another reservation property.</span>
<span class="s1">Enter an empty property name when done.</span>
<span class="s1">? Property name: endDate</span>
<span class="s1">   invoke   loopback:property</span>
<span class="s1">? Property type: date</span>
<span class="s1">? Required? Yes</span>
<span class="s1">? Default value[leave blank for none]:</span>

<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">another</span> <span class="nx">reservation</span> <span class="nx">property</span><span class="p">.</span>
<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span>
</pre></div><h2 id="relations">Relations</h2><p>Campgrounds can have zero or more reservations. We have to create a <a href="https://loopback.io/doc/en/lb3/Define-model-relations.html">relationship between our models</a> to accomplish this, <code>lb relation</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">create</span> <span class="nx">the</span> <span class="nx">relationship</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">campground</span>
<span class="o">?</span> <span class="nx">Relation</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">has</span> <span class="nx">many</span>
<span class="o">?</span> <span class="nx">Choose</span> <span class="nx">a</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">create</span> <span class="nx">a</span> <span class="nx">relationship</span> <span class="kd">with</span><span class="o">:</span> <span class="nx">reservation</span>
<span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">property</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">relation</span><span class="o">:</span> <span class="nx">reservations</span>
<span class="o">?</span> <span class="nx">Optionally</span> <span class="nx">enter</span> <span class="nx">a</span> <span class="nx">custom</span> <span class="nx">foreign</span> <span class="nx">key</span><span class="o">:</span>
<span class="o">?</span> <span class="nx">Require</span> <span class="nx">a</span> <span class="nx">through</span> <span class="nx">model</span><span class="o">?</span> <span class="nx">No</span>
</pre></div><p>Start the server again and go to the API Explorer. You will see some new endpoints for /campgrounds/{id}/reservations.</p><p>Let’s update our test data so we have a couple of reservations for our campgrounds.</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;ids&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="mi">3</span>
  <span class="p">},</span>
  <span class="s2">&quot;models&quot;</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="p">{</span>
       <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Salt Lake City KOA\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 40.772112, \&quot;lng\&quot;: -111.932165},\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Gouldings Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 37.006989, \&quot;lng\&quot;: -110.214907},\&quot;id\&quot;:2}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;3&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Grand Canyon Mather Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 36.056472, \&quot;lng\&quot;: -112.140728},\&quot;id\&quot;:3}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;4&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Camping Paris Bois de Boulogne\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 48.868879, \&quot;lng\&quot;: 2.234914},\&quot;id\&quot;:4}&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="p">{</span>
       <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;startDate\&quot;:\&quot;2017-03-21\&quot;,\&quot;endDate\&quot;:\&quot;2017-03-23\&quot;,\&quot;campgroundId\&quot;:1,\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
       <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;startDate\&quot;:\&quot;2017-03-25\&quot;,\&quot;endDate\&quot;:\&quot;2017-03-31\&quot;,\&quot;campgroundId\&quot;:2,\&quot;id\&quot;:2}&quot;</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><h2 id="queries">Queries</h2><p>Loopback endpoints can also be used to <a href="https://loopback.io/doc/en/lb3/Querying-data.html">query specific data</a>. Here’s a selection of what is possible out of the box:</p><ul><li>Show all campgrounds with ’KOA’ in there name<br><code>/api/campgrounds?filter[where][name][like]=KOA</code></li><li>Show all reservations after or on 2017–03–22<br><code>/api/reservations?filter[where][startDate][gte]=2017-03-22</code></li><li>Show only the names of the campgrounds:<br><code>/api/campgrounds?filter[fields][name]=true</code></li><li>Show everything but the names of the campgrounds:<br><code>/api/campgrounds?filter[fields][name]</code></li><li>Show campgrounds and include their reservations:<br><code>/api/campgrounds?filter[include][reservations]</code></li><li>Show the first 2 campgrounds:<br><code>/api/campgrounds?filter[limit]=2</code></li><li>Show the next 2 campgrounds:<br><code>/api/campgrounds?filter[skip]=2&amp;filter[limit]=2</code></li><li>Order campgrounds by name<br><code>/api/campgrounds?filter[order]=name</code></li><li>Descending order campgrounds by name:<br><code>/api/campgrounds?filter[order]=name%20DESC</code></li></ul><h2 id="geolocation">Geolocation</h2><p>You can also query based on geolocation. The location of our campground is a <a href="https://loopback.io/doc/en/lb3/Geotype.html">geopoint</a>.<br>Imagine we are at Arches Nation Park and we want to search for all campgrounds within a 200 mile radius:</p><div class="highlight"><pre><span></span><span class="err">/api/campgrounds?filter[where][location][near]=38.7006538,-109.5643742&amp;filter[where][location][maxDistance]=200</span>
</pre></div><h2 id="validation">Validation</h2><p>When we created the campground model, we made the name required. If we try to create a campground without a name, loopback will give us a validation error saying that the field cannot be blank. </p><p>Loopback also has some built-in <a href="https://loopback.io/doc/en/lb2/Validating-model-data.html#using-validation-methods">validation methods</a> for frequently used validation. The name of our campground should have max. 100 characters. We can implement this by adding the following code to server/models/campground.js:</p><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Campground</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">Campground</span><span class="p">.</span><span class="nx">validatesLengthOf</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">max</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="p">{</span><span class="nx">max</span><span class="o">:</span> <span class="s1">&#39;Name is too long&#39;</span><span class="p">}});</span>
<span class="p">};</span>
</pre></div><p>You can also add custom validation. For a reservation, the endDate should be after the startDate:</p><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Reservation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Reservation</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="s1">&#39;startDate&#39;</span><span class="p">,</span> <span class="nx">dateValidator</span><span class="p">,</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;endDate should be after startDate&#39;</span><span class="p">});</span>
    <span class="kd">function</span> <span class="nx">dateValidator</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">endDate</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div><h2 id="security">Security</h2><p>All our endpoints are public. We should add some security here. Our example will have 3 types of users. Anonymous users should be able to see all campgrounds. When they register, they will become customers who can make reservations and can see only there own reservations.</p><p>Administrators should be able to see and do anything. Loopback has <a href="http://loopback.io/doc/en/lb3/Using-built-in-models.html">built-in models</a> for security, but it is advised not to use them directly. We will create a customer model that extends from the User model. <code>lb model</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">customer</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">data</span><span class="o">-</span><span class="nx">source</span> <span class="nx">to</span> <span class="nx">attach</span> <span class="nx">customer</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">reservationDS</span> <span class="p">(</span><span class="nx">memory</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">model</span><span class="s1">&#39;s base class User</span>
<span class="s1">? Expose customer via the REST API? Yes</span>
<span class="s1">? Custom plural form (used to build REST URL):</span>
<span class="s1">? Common model or server only? server</span>
<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">some</span> <span class="nx">customer</span> <span class="nx">properties</span> <span class="nx">now</span><span class="p">.</span>

<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span>
   <span class="nx">invoke</span>   <span class="nx">loopback</span><span class="o">:</span><span class="nx">property</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span>
<span class="o">?</span> <span class="nx">Required</span><span class="o">?</span> <span class="nx">No</span>
<span class="o">?</span> <span class="nx">Default</span> <span class="nx">value</span><span class="p">[</span><span class="nx">leave</span> <span class="nx">blank</span> <span class="k">for</span> <span class="nx">none</span><span class="p">]</span><span class="o">:</span>

<span class="nx">Let</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">another</span> <span class="nx">customer</span> <span class="nx">property</span><span class="p">.</span>
<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span>
</pre></div><p>Customers can have zero or more reservations. Let's create a relation here, <code>lb relation</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">create</span> <span class="nx">the</span> <span class="nx">relationship</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">customer</span>
<span class="o">?</span> <span class="nx">Relation</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">has</span> <span class="nx">many</span>
<span class="o">?</span> <span class="nx">Choose</span> <span class="nx">a</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">create</span> <span class="nx">a</span> <span class="nx">relationship</span> <span class="kd">with</span><span class="o">:</span> <span class="nx">reservation</span>
<span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">property</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">relation</span><span class="o">:</span> <span class="nx">reservations</span>
<span class="o">?</span> <span class="nx">Optionally</span> <span class="nx">enter</span> <span class="nx">a</span> <span class="nx">custom</span> <span class="nx">foreign</span> <span class="nx">key</span><span class="o">:</span>
<span class="o">?</span> <span class="nx">Require</span> <span class="nx">a</span> <span class="nx">through</span> <span class="nx">model</span><span class="o">?</span> <span class="nx">No</span>
</pre></div><p>Since we started from an empty server, the built-in models are not defined in server/model-config.json. Let's add those now.</p><p>Setting the 'public' property to false means that they will not be public and will not be shown in our API explorer.</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_meta&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;sources&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;loopback/common/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;loopback/server/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;../common/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;./models&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;mixins&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;loopback/common/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;loopback/server/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;../common/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;./mixins&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;customer&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;User&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;AccessToken&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;ACL&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;RoleMapping&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;Role&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>We will now add 3 users to application:</p><ul><li>Andy, our administrator : (username: andy, password: andy)</li><li>Kenneth, a customer : (username: kenneth, password: kenneth)</li><li>Claudiu, another customer: (username: claudiu, password: claudiu)</li></ul><p>The passwords need to be hashed in the db.json file. We also link our reservations to our customers.</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;ids&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;customer&quot;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;AccessToken&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ACL&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;RoleMapping&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;Role&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="s2">&quot;models&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Salt Lake City KOA\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 40.772112, \&quot;lng\&quot;: -111.932165},\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Gouldings Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 37.006989, \&quot;lng\&quot;: -110.214907},\&quot;id\&quot;:2}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;3&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Grand Canyon Mather Campground\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 36.056472, \&quot;lng\&quot;: -112.140728},\&quot;id\&quot;:3}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;4&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Camping Paris Bois de Boulogne\&quot;,\&quot;location\&quot;:{\&quot;lat\&quot;: 48.868879, \&quot;lng\&quot;: 2.234914},\&quot;id\&quot;:4}&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;startDate\&quot;:\&quot;2017-03-21\&quot;,\&quot;endDate\&quot;:\&quot;2017-03-23\&quot;,\&quot;campgroundId\&quot;:1,\&quot;customerId\&quot;:2,\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;startDate\&quot;:\&quot;2017-03-25\&quot;,\&quot;endDate\&quot;:\&quot;2017-03-31\&quot;,\&quot;campgroundId\&quot;:2,\&quot;customerId\&quot;:3,\&quot;id\&quot;:2}&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;customer&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Andy Van Den Heuvel\&quot;,\&quot;username\&quot;:\&quot;andy\&quot;,\&quot;password\&quot;:\&quot;$2a$10$1lmPRI0Xjd5fU8HGdPmDoOkZpIPJj2axcdJYIfc/3RUnBDDqQe31K\&quot;,\&quot;email\&quot;:\&quot;andy@optis.be\&quot;,\&quot;id\&quot;:1}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Kenneth Van den Berghe\&quot;,\&quot;username\&quot;:\&quot;kenneth\&quot;,\&quot;password\&quot;:\&quot;$2a$10$H5wtnFvhxf8CPn66gEbPu.tki2WRpkplqvUV3yhQ049ugY8rHFSJi\&quot;,\&quot;email\&quot;:\&quot;kenneth@optis.be\&quot;,\&quot;id\&quot;:2}&quot;</span><span class="p">,</span>
      <span class="s2">&quot;3&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;Claudiu Matei\&quot;,\&quot;username\&quot;:\&quot;claudiu\&quot;,\&quot;password\&quot;:\&quot;$2a$10$6b9jxIwb6y84gpq.ZU57YegRM4BWxHoXc.K/WwlEOJTa/9fO7cCta\&quot;,\&quot;email\&quot;:\&quot;claudiu@optis.be\&quot;,\&quot;id\&quot;:3}&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;AccessToken&quot;</span><span class="o">:</span> <span class="p">{},</span>
    <span class="s2">&quot;ACL&quot;</span><span class="o">:</span> <span class="p">{},</span>
    <span class="s2">&quot;RoleMapping&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;principalType\&quot;:\&quot;USER\&quot;,\&quot;principalId\&quot;:\&quot;1\&quot;,\&quot;roleId\&quot;:1,\&quot;id\&quot;:1}&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;Role&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;{\&quot;name\&quot;:\&quot;admin\&quot;,\&quot;created\&quot;:\&quot;2017-02-21T06:07:25.571Z\&quot;,\&quot;modified\&quot;:\&quot;2017-02-21T06:07:25.571Z\&quot;,\&quot;id\&quot;:1}&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>We will now activate our authentication. To do this, we must add a <a href="https://loopback.io/doc/en/lb3/Defining-boot-scripts.html">bootscript</a>. Create a new file server/boot/authentication.js with the following content and restart your server afterwards.</p><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">enableAuthentication</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">enableAuth</span><span class="p">();</span>
<span class="p">};</span>
</pre></div><p>Authentication is now enabled, but all endpoints are still public because we haven't configured any authorization. Loopback uses <a href="https://loopback.io/doc/en/lb3/Controlling-data-access.html">access control lists</a> for this. Let's add some rules here.</p><p>First deny all access to everybody, <code>lb acl</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">entry</span> <span class="nx">to</span><span class="o">:</span> <span class="p">(</span><span class="nx">all</span> <span class="nx">existing</span> <span class="nx">models</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">All</span> <span class="nx">methods</span> <span class="nx">and</span> <span class="nx">properties</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">access</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">All</span> <span class="p">(</span><span class="nx">match</span> <span class="nx">all</span> <span class="nx">types</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">role</span> <span class="nx">All</span> <span class="nx">users</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">permission</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">Explicitly</span> <span class="nx">deny</span> <span class="nx">access</span>
</pre></div><p>Now allow everybody to view the campgrounds, <code>lb acl</code></p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">entry</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">campground</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">All</span> <span class="nx">methods</span> <span class="nx">and</span> <span class="nx">properties</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">access</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Read</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">role</span> <span class="nx">All</span> <span class="nx">users</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">permission</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">Explicitly</span> <span class="nx">grant</span> <span class="nx">access</span>
</pre></div><p>Also, allow every customer to their own info, <code>lb acl</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">entry</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">customer</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">All</span> <span class="nx">methods</span> <span class="nx">and</span> <span class="nx">properties</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">access</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">All</span> <span class="p">(</span><span class="nx">match</span> <span class="nx">all</span> <span class="nx">types</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">role</span> <span class="nx">The</span> <span class="nx">user</span> <span class="nx">owning</span> <span class="nx">the</span> <span class="nx">object</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">permission</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">Explicitly</span> <span class="nx">grant</span> <span class="nx">access</span>
</pre></div><p>And as a last rule, allow administrators to do and see all, <code>lb acl</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">entry</span> <span class="nx">to</span><span class="o">:</span> <span class="p">(</span><span class="nx">all</span> <span class="nx">existing</span> <span class="nx">models</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">ACL</span> <span class="nx">scope</span><span class="o">:</span> <span class="nx">All</span> <span class="nx">methods</span> <span class="nx">and</span> <span class="nx">properties</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">access</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">All</span> <span class="p">(</span><span class="nx">match</span> <span class="nx">all</span> <span class="nx">types</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">role</span> <span class="nx">other</span>
<span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">role</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">admin</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">permission</span> <span class="nx">to</span> <span class="nx">apply</span> <span class="nx">Explicitly</span> <span class="nx">grant</span> <span class="nx">access</span>
</pre></div><p>Start your server and go to http://localhost:3000/api/campgrounds. As an anonymous user I can still see all campgrounds. When I go to http://localhost:3000/api/reservations, I get a 401 Authorization Required.</p><p>We will now log in as Kenneth to see his reservations. Go to http://localhost:3000/explorer/#!/customer/customer_login and log in:</p><p><img src="/img/0001_login.png" alt="Login"></p><p>The id of the response is a generated access token. You can now copy it and set it in the header to provide the access token for all calls in the API Explorer.</p><p><img src="/img/0001_token.png" alt="Login"></p><p>Or you can add the access token as a request parameter. Let's try this out.</p><ul><li>As Kenneth, I can see my own reservations: <code>/api/customers/2/reservations?access_token=XMFN5GsykpxFokvWsXRYtKZidlJYKyClvak0KmEn87LisnFYSQ9TzmrBcz9GFrHv</code></li><li>Asking Claudiu's reservations results in an 401 unauthorized: <code>/api/customers/3/reservations?access_token=XMFN5GsykpxFokvWsXRYtKZidlJYKyClvak0KmEn87LisnFYSQ9TzmrBcz9GFrHv</code></li><li>As Claudiu, I can see my own reservation: <code>/api/customers/3/reservations?access_token=v51y2iZa1nkKTWC7s1yKELaIatfDJPVxcEEVa6FFIG4llZCGyZVbwR4plhfpYAxx</code></li><li>But I can't see Kenneth's reservations: <code>/api/customers/2/reservations?access_token=v51y2iZa1nkKTWC7s1yKELaIatfDJPVxcEEVa6FFIG4llZCGyZVbwR4plhfpYAxx</code></li><li>As Andy, I can see Kenneth's reservations: <code>/api/customers/2/reservations?access_token=okxVkWcdoVzWb3WmCK9KkiuBArz1HOOHrIn1h2mOfa0kBzeUna1V9wFmFRe6BCHe</code></li><li>And also Claudiu's reservations: <code>/api/customers/3/reservations?access_token=okxVkWcdoVzWb3WmCK9KkiuBArz1HOOHrIn1h2mOfa0kBzeUna1V9wFmFRe6BCHe</code></li><li>As Andy you can also see all reservations: <code>/api/reservations?access_token=okxVkWcdoVzWb3WmCK9KkiuBArz1HOOHrIn1h2mOfa0kBzeUna1V9wFmFRe6BCHe</code></li></ul><h2 id="application_logic">Application logic</h2><p>Up to this point, we were able to build a fully functioning REST API, mostly from generating code. But more advanced applications will almost always need some extra application logic.</p><p>Loopback allows you to add remote methods, remote hooks and operation hooks. Remote hooks and operation hooks are practically the same. The difference is that operational hooks are more high-level defined, whereas remote hooks are more specific to an endpoint.</p><p>In our example, we want to send a verification email when a customer has made a reservation. Loopback has an [email connector](https://loopback.io/doc/en/lb3/Email-connector.html) available based on <a href="https://nodemailer.com">Nodemailer</a></p><p>Go to server/datasources.json and add the email configuration. I used gmail for this:</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;reservationDS&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;localStorage&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;file&quot;</span><span class="o">:</span> <span class="s2">&quot;db.json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;memory&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;emailDS&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;mail&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;mail&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transports&quot;</span><span class="o">:</span> <span class="p">[{</span>
      <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;SMTP&quot;</span><span class="p">,</span>
      <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span>
      <span class="s2">&quot;secure&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">465</span><span class="p">,</span>
      <span class="s2">&quot;auth&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_USER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_PASSWORD&quot;</span>
      <span class="p">}</span>
    <span class="p">}]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Now we bind the datasource in server/models-config.js:</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_meta&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;sources&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;loopback/common/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;loopback/server/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;../common/models&quot;</span><span class="p">,</span>
      <span class="s2">&quot;./models&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;mixins&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;loopback/common/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;loopback/server/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;../common/mixins&quot;</span><span class="p">,</span>
      <span class="s2">&quot;./mixins&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;campground&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;reservation&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;customer&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="s2">&quot;User&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;AccessToken&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;ACL&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;RoleMapping&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;Role&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public&quot;</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="s2">&quot;Email&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;dataSource&quot;</span><span class="o">:</span> <span class="s2">&quot;emailDS&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Go to server/models/reservation.js and add the logic to send and email after save:</p><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Reservation</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Reservation</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="s1">&#39;startDate&#39;</span><span class="p">,</span> <span class="nx">dateValidator</span><span class="p">,</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;endDate should be after startDate&#39;</span><span class="p">});</span>
  <span class="kd">function</span> <span class="nx">dateValidator</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">endDate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">err</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">Reservation</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="s2">&quot;after save&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Reservation</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Campground</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">campgroundId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">campground</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Reservation</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Email</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="nx">to</span><span class="o">:</span> <span class="s1">&#39;andy@optis.be&#39;</span><span class="p">,</span>
        <span class="nx">from</span><span class="o">:</span> <span class="s1">&#39;noreply@optis.be&#39;</span><span class="p">,</span>
        <span class="nx">subject</span><span class="o">:</span> <span class="s1">&#39;Thank you for your reservation at &#39;</span> <span class="o">+</span> <span class="nx">campground</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">html</span><span class="o">:</span> <span class="s1">&#39;&lt;p&gt;We confirm your reservation for &lt;strong&gt;&#39;</span> <span class="o">+</span> <span class="nx">campground</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/strong&gt;&lt;/p&gt;&#39;</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mail</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;email sent!&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">};</span>
</pre></div><h2 id="storage">Storage</h2><p>If you are interested in uploading/downloading files from your API, you can use Loopback's <a href="https://loopback.io/doc/en/lb3/Storage-component.html">Storage Component</a>. For this, you need to install the storage component via NPM:</p><div class="highlight"><pre><span></span><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">loopback</span><span class="o">-</span><span class="nx">component</span><span class="o">-</span><span class="nx">storage</span> <span class="o">--</span><span class="nx">save</span>
</pre></div><p>Just like with emails, the storage component is called a datasource. Let's add it to server/datasources.json</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;reservationDS&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;reservationDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;localStorage&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;file&quot;</span><span class="o">:</span> <span class="s2">&quot;db.json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;memory&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;emailDS&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;mail&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;mail&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transports&quot;</span><span class="o">:</span> <span class="p">[{</span>
      <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;SMTP&quot;</span><span class="p">,</span>
      <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span>
      <span class="s2">&quot;secure&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">465</span><span class="p">,</span>
      <span class="s2">&quot;auth&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_USER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_PASSWORD&quot;</span>
      <span class="p">}</span>
    <span class="p">}]</span>
  <span class="p">},</span>
  <span class="s2">&quot;photos&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;photos&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;loopback-component-storage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;provider&quot;</span><span class="o">:</span> <span class="s2">&quot;filesystem&quot;</span><span class="p">,</span>
    <span class="s2">&quot;root&quot;</span><span class="o">:</span> <span class="s2">&quot;./server/files&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>We use our local filesystem as the provider here, but the storage component uses <a href="https://github.com/pkgcloud/pkgcloud">pkgcloud</a> to support multiple cloud providers (Amazon, Azure, Google, HP, Openstack, Rackspace)</p><p>Loopback keeps files in containers. We have to make a container model so we can create a container for our photos, <code>lb model</code>:</p><div class="highlight"><pre><span></span><span class="o">?</span> <span class="nx">Enter</span> <span class="nx">the</span> <span class="nx">model</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">container</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="nx">data</span><span class="o">-</span><span class="nx">source</span> <span class="nx">to</span> <span class="nx">attach</span> <span class="nx">container</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">photos</span> <span class="p">(</span><span class="nx">loopback</span><span class="o">-</span><span class="nx">component</span><span class="o">-</span><span class="nx">storage</span><span class="p">)</span>
<span class="o">?</span> <span class="nx">Select</span> <span class="nx">model</span><span class="s1">&#39;s base class Model</span>
<span class="s1">? Expose container via the REST API? Yes</span>
<span class="s1">? Custom plural form (used to build REST URL):</span>
<span class="s1">? Common model or server only? server</span>
<span class="s1">Let&#39;</span><span class="nx">s</span> <span class="nx">add</span> <span class="nx">some</span> <span class="nx">container</span> <span class="nx">properties</span> <span class="nx">now</span><span class="p">.</span>

<span class="nx">Enter</span> <span class="nx">an</span> <span class="nx">empty</span> <span class="nx">property</span> <span class="nx">name</span> <span class="nx">when</span> <span class="nx">done</span><span class="p">.</span>
<span class="o">?</span> <span class="nx">Property</span> <span class="nx">name</span><span class="o">:</span>
</pre></div><p>Create the server/files/photos folder, so we can upload some photos to it and start your server. When you go to the API explorer, you can see the /containers endpoint, but we haven't created any containers yet. For this part, we are going to use curl.</p><p>Create the container 'photos':</p><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">GET</span> <span class="o">--</span><span class="nx">header</span> <span class="s1">&#39;Accept: application/json&#39;</span> <span class="s1">&#39;http://localhost:3000/api/containers/photos&#39;</span>
</pre></div><p>Upload to the 'photos'-container:</p><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">F</span> <span class="s2">&quot;image=@image.jpg&quot;</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/api/containers/photos/upload</span>
</pre></div><p>Download from the 'photos'-container:</p><div class="highlight"><pre><span></span><span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/api/containers/photos/download/image.jpg</span>
</pre></div><h2 id="testing">Testing</h2><p>We are almost ready, but we want to ensure we can test our endpoints. We will use <a href="http://mochajs.org">mocha</a>, <a href="http://chaijs.com">chai</a> and <a href="http://chaijs.com/plugins/chai-http">chai-http</a> for this.</p><p>If you haven't mocha on your machine. Install it globally via npm</p><div class="highlight"><pre><span></span><span class="nx">npm</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">g</span> <span class="nx">mocha</span>
</pre></div><p>Then install chai and chai-http for the project:</p><div class="highlight"><pre><span></span><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">chai</span> <span class="nx">chai</span><span class="o">-</span><span class="nx">http</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div><p>We can now write a test at test/campground.js. I haven't written the complete testsuite here, just a few tests so you get the idea. chai will make sure that the server is started before we do the request, and stopped after the test.</p><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">chai</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chai&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">chaiHttp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chai-http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../server/server&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">should</span> <span class="o">=</span> <span class="nx">chai</span><span class="p">.</span><span class="nx">should</span><span class="p">();</span>

<span class="nx">chai</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">chaiHttp</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Campgrounds&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should show all campgrounds on GET /api/campgrounds&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/campgrounds&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should show only the names of the campgrounds on GET /api/campgrounds?filter[fields][name]=true&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/campgrounds?filter[fields][name]=true&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should show the first 2 campgrounds on GET /api/campgrounds?filter[limit]=2&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/campgrounds?filter[limit]=2&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Salt Lake City KOA&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Gouldings Campground&#39;</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should show the last 2 campgrounds on GET /api/campgrounds?filter[skip]=2&amp;filter[limit]=2&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/campgrounds?filter[skip]=2&amp;filter[limit]=2&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Grand Canyon Mather Campground&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Camping Paris Bois de Boulogne&#39;</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div><p>Run the command <code>mocha</code> now and you should see all tests passing:</p><p><img src="/img/0001_testing.png" alt="testing"></p><p>Ok, we're almost done now. Last stop: Deploy to Production.</p><h2 id="deployment">Deployment</h2><p>In order to go to production, we need some <a href="https://loopback.io/doc/en/lb3/Environment-specific-configuration.html">Environment-specific configuration</a>.</p><p>Loopback has naming conventions for this. For security reasons, we don't want to show the API explorer when running in production. Create a file named /server/component-config.prod.json</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;loopback-component-explorer&quot;</span><span class="o">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div><p>We also don't want to work against an in-memory database. We will switch to mongoDB here. We will have to install the <a href="https://loopback.io/doc/en/lb3/MongoDB-connector.html">MongoDB Connector</a> for it:</p><div class="highlight"><pre><span></span><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">loopback</span><span class="o">-</span><span class="nx">connector</span><span class="o">-</span><span class="nx">mongodb</span> <span class="o">--</span><span class="nx">save</span>
</pre></div><p>I will use an <a href="https://mlab.com">MLab</a>-hosted MongoDB. You can sign up and create a free sandbox here too.</p><ul><li>Create a database 'reservations'</li><li>The username credentials you used to signup for MLab are not used to connect in your application, make sure you create a database user here:</li></ul><p><img src="/img/0001_mlab.png" alt="MLab"></p><p>Create a new file called server/datasources.prod.json and add your mongodb settings:</p><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;reservationDS&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;host&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_HOST&quot;</span><span class="p">,</span>
    <span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
    <span class="s2">&quot;database&quot;</span><span class="o">:</span> <span class="s2">&quot;reservations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;reservations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;connector&quot;</span><span class="o">:</span> <span class="s2">&quot;mongodb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_USERNAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="o">:</span> <span class="s2">&quot;YOUR_PASSWORD&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Notice dat we use the naming pattern componenet-config.env.json and datasources.env.json here. Loopback uses NODE_ENV to decide what config should be loaded. Let's change our environment to prod.</p><div class="highlight"><pre><span></span><span class="kr">export</span> <span class="nx">NODE_ENV</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span>
</pre></div><p>Loopback will now use our new configuration. Our explorer is disabled and we can still use are api, this time through MongoDB:</p><div class="highlight"><pre><span></span><span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/api/campgrounds</span>
</pre></div><p>Since we are working on mongoDB now, we don't have any test data available anymore. Let's create a collection 'campground' and when you click on the collection, you can add a new document.</p><p>You can do all of this inside the mLab web interface. E.g:</p><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Salt Lake City KOA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;location&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;lat&quot;</span><span class="o">:</span> <span class="mf">40.772112</span><span class="p">,</span>
        <span class="s2">&quot;lng&quot;</span><span class="o">:</span> <span class="o">-</span><span class="mf">111.932165</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>When you created the document and go to http://localhost:3000/api/campgrounds and you should see the newly created.</p></div></body></html>